# История формата

ORC: Optimized RC Format (где RC = Record Columnar), собственно базируется на своем предшественнике (RC Format-е) и 
всего-лишь

`the smallest, fastest columnar storage for Hadoop workloads`
  
(это цитата с главной страницы проекта - https://orc.apache.org/. Немного погрузившись - я ей верю...)

Формат уже не юн - создан в 2013 году, сейчас стабильная версия - v1, в работе - v2. 
Достаточно хорошо документирован - все, о чем я здесь пишу, базируется на спецификации 
(https://orc.apache.org/specification/) и проверено питновским кодом (который здесь же).

# Верхнеуровневое описание формата

ORC файл полностью самодостаточен (как и любой другой формат Hadoop - иначе как читать, никаких отдельных метаданных нет...). 
Файл состоит из достаточно больших "страйпов" (stripes) порядка 64МБ каждый и "хвостовичка", содержащего общую для всего файла метаинформацию. Страйп является также самодостаточным (в плане данных) и содержит подмножество строк исходной таблицы. Для чтения данных (подмножества строк) достаточно прочитать хвостовик файла (мета информацию) и страйп(ы), который содержит данные нужных строк.

Формат ориентирован на хранение колонок - в пределах страйпа можно прочитать данные каждой из колонок независимо.

Каждая часть файла (про "части" - ниже) может быть сжата (ZLIB, например), при этом опять же сжатие не должно мешать возможности считать части файла по отдельности.

Файл содержит индексы (на трех уровнях: файл, страйп и блок строк, про блоки - ниже). Что дополнительно ускоряет чтение данных из файла.

Значения колонок хранятся в encoded виде (например, RLE), причем виды кодировки для одной колонки в пределах одного блока строк могут быть разными - все зависит от данных. Кстати, именно этим объясняется тот размер (628 байт), который был приведен выше: данные "легли" так удачно, что RLE кодировка их ну совсем сжала... См. детали ниже.
Ну и в завершение - метаданные хранятся с использованием Protocol Buffers (https://developers.google.com/protocol-buffers/docs/encoding), что тоже прикольно.
